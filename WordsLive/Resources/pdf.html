<!doctype html>
<html>

<head>
  <title>PDF</title>
  <!-- In production, only one script (pdf.js) is necessary -->
  <script type="text/javascript" src="asset://WordsLive.Core/pdf.js"></script>
  <script type="text/javascript" src="asset://WordsLive.Core/jquery.js"></script>
  <script type="text/javascript" src="asset://WordsLive.Core/jquery.mousewheel.js"></script>

  <script type="text/javascript">
	  // Specify the main script used to create a new PDF.JS web worker.
	  // In production, change this to point to the combined `pdf.js` file.
	  PDFJS.workerSrc = 'asset://WordsLive.Core/pdf.js';
  </script>
  
  <style>
  body { margin: 0; overflow: hidden;}
  .pdfpage { position:relative; top: 0; left: 0; border-bottom: 1px solid gray; margin: 0; }
  .pdfpage > canvas { position: absolute; top: 0; left: 0; }
  .pdfpage > div { position: absolute; top: 0; left: 0; }
  </style>

  <script type="text/javascript">
	  'use strict';

	function renderPage(div, pdf, pageNumber, callback) {
		pdf.getPage(pageNumber).then(function(page) {
			var unscaledViewport = page.getViewport(1);
			var scale = $(document).width() / unscaledViewport.width;
			var viewport = page.getViewport(scale);

			var pageDisplayWidth = viewport.width;
			var pageDisplayHeight = viewport.height;

			var pageDivHolder = document.createElement('div');
			pageDivHolder.className = 'pdfpage';
			$(pageDivHolder).attr('id', 'page_'+pageNumber);
			pageDivHolder.style.width = pageDisplayWidth + 'px';
			pageDivHolder.style.height = pageDisplayHeight + 'px';
			div.appendChild(pageDivHolder);

			// Prepare canvas using PDF page dimensions
			var canvas = document.createElement('canvas');
			var context = canvas.getContext('2d');
			canvas.width = pageDisplayWidth;
			canvas.height = pageDisplayHeight;
			pageDivHolder.appendChild(canvas);


			// Render PDF page into canvas context
			var renderContext = {
				canvasContext: context,
				viewport: viewport
			};
			page.render(renderContext).then(callback);

			// Prepare and populate form elements layer
			var formDiv = document.createElement('div');
			pageDivHolder.appendChild(formDiv);
		});
	}

	var doc;

	function renderAll() {
		// Rendering all pages starting from first
		var viewer = document.getElementById('viewer');
		$(viewer).empty();
		var pageNumber = 1;
		renderPage(viewer, doc, pageNumber++, function pageRenderingComplete() {
			if (pageNumber > doc.numPages)
				return; // All pages rendered
			// Continue rendering of the next page
			renderPage(viewer, doc, pageNumber++, pageRenderingComplete);
		});
	}

	// Fetch the PDF document from the URL using promices
	PDFJS.getDocument(bridge.document).then(function getPdfForm(pdf) {
		doc = pdf;
		renderAll();
	});

	$(window).resize(function () {
		renderAll();
	});

	$(function () {
		$('#viewer').bind("mousewheel", function (ev, delta) {
			var scrollTop = $(window).scrollTop();
			$(window).scrollTop(scrollTop - Math.round(delta*50));
		});
	});

	function gotoPage(p) {
		if (p >= 1 && p <= doc.numPages) {
			$(window).scrollTop($('#page_'+p).offset().top)
		}
	}
	  
	function getCurrentPage() {
		var t = $(window).scrollTop();
		if (t == 0)
			return 1;
			
		for (var p = 1; p <= doc.numPages; p++) {
			if ($('#page_'+p).offset().top >= t)
				return p-1;
		}
		return doc.numPages;
	}
	  
	function nextPage() {
		gotoPage(getCurrentPage() + 1);
	}
	  
	function prevPage() {
		gotoPage(getCurrentPage() - 1);
	}
  </script>
</head>

<body>
  <div id="viewer"></div>
</body>

</html>
